---
name: security-invariants
description: >
  ISCL security model, threat mitigations, and invariants that must never be violated. Use
  before any code change that touches trust boundaries, key handling, signing paths, sandbox
  isolation, network access, or approval flows. Also use when writing security tests or
  reviewing PRs for security implications. Triggers: security review, threat model, key
  isolation, sandbox escape, signing bypass, exfiltration, replay attack, supply chain.
---

# Security Invariants

These invariants must hold at ALL times. Any violation is a critical bug.

## Five Core Invariants

1. **Private keys exist only in Domain B (ISCL Core).** Never in Domain A (skills) or C (sandbox).
2. **Every signature passes PolicyEngine + Preflight.** If approval mode is on, human confirmation is required.
3. **Skills have no direct RPC access.** Only ISCL Core contacts the blockchain via allowlisted RPCs.
4. **All fund-affecting operations use TxIntent v1.** No arbitrary calldata signing exists in v0.1.
5. **All critical steps are logged to AuditTrace** with correlation: `intentId → preflight → approval → signature → txHash → receipt`.

## Threat → Mitigation Quick Reference

| Threat | Domain | Mitigation |
|---|---|---|
| Skill reads keys from env/fs | A | Keys physically absent in Domain A |
| Skill makes arbitrary network request | A,C | Network allowlist, no outbound by default |
| Skill spoofs approval UI text | A | Approval text generated by ISCL Core from build+preflight, not skill |
| Skill sends harmful TxIntent | A | Strict schema + PolicyEngine + Preflight risk scoring |
| Sandbox code accesses keys | C | Keys absent in Domain C, IPC boundary |
| Sandbox code downloads payload | C | Network allowlist_only |
| Sandbox spawns processes | C | `no_spawn`, cgroup limits, timeouts |
| Package tampered | C | Signed manifest + sha256 file hashes |
| RPC returns false data | B | Multi-RPC comparison (optional), risk elevation on mismatch |
| Signing bypasses policy | B | Single signing method requires PolicyDecision + ApprovalToken |
| Replay of approval token | B | Single-use token, bound to intentId + txRequestHash, TTL |
| MaxUint approval drains funds | B | `maxApprovalAmount` policy, bounded approvals by default |

## Code Review Security Checklist

Before merging any PR, verify:

- [ ] No new path exists to call WalletService.sign without PolicyDecision
- [ ] No key material is logged, returned in API responses, or passed to Domain A/C
- [ ] No new network call bypasses the RPC allowlist
- [ ] Any new API endpoint validates input with AJV strict schema
- [ ] Sandbox changes don't weaken FS/network/process isolation
- [ ] Approval tokens remain single-use and TTL-bound
- [ ] New audit events added for any new critical path
- [ ] No `eval()`, `Function()`, or dynamic code loading in Core

## What Is Out of Scope (v0.1)

- OS-level compromise / rootkit → mitigate with hardware wallet in v0.2
- User social engineering → show clear approval summary, but can't fully prevent
- Formal verification of sandbox → planned for post-v0.1

## Security Test IDs

Reference these when writing or updating security tests:

```
SecurityTest_A1: SkillKeyExfiltration
SecurityTest_A2: NoExternalNetworkFromSkill
SecurityTest_A3: ApprovalSummarySourceOfTruth
SecurityTest_A4: PolicyDeniesBadIntents
SecurityTest_C1: ExecutorCannotReadKeys
SecurityTest_C2: NetworkAllowlist
SecurityTest_C3: NoSpawnNoMine
SecurityTest_C4: TamperedPackageRejected
SecurityTest_B1: RpcMismatchElevatesRisk
SecurityTest_B2: NoBypassSigning
SecurityTest_B3: ApprovalTokenSingleUse
SecurityTest_B4: ApprovalBounded
```
